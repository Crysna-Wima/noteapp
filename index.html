<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Catatan Crysna</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;600;700&family=DM+Sans:ital,wght@0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { hand:['Caveat','cursive'], body:['DM Sans','sans-serif'] },
          colors: { cork:'#c4a882','cork-dark':'#a68b6b', cream:'#fdf6ec', ink:'#2c1810' }
        }
      }
    }
  </script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'DM Sans',sans-serif;overflow:hidden;height:100vh}

    .login-bg{background:linear-gradient(135deg,#fdf6ec 0%,#f0e6d3 50%,#e8d5b8 100%);min-height:100vh}

    ::-webkit-scrollbar{width:6px;height:6px}
    ::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:rgba(0,0,0,.15);border-radius:4px}

    /* Sidebar */
    .sidebar{width:280px;background:rgba(253,246,236,.97);backdrop-filter:blur(12px);border-right:1px solid rgba(196,168,130,.25);transition:width .3s cubic-bezier(.4,0,.2,1),min-width .3s;overflow:hidden}
    .sidebar.collapsed{width:0;min-width:0;border-right:none}
    .sidebar-item{cursor:pointer;transition:background .15s;border-left:3px solid transparent}
    .sidebar-item:hover{background:rgba(196,168,130,.15)}
    .sidebar-item.active{background:rgba(196,168,130,.22);border-left-color:#a68b6b}
    .sidebar-color-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}

    /* Bars */
    .top-bar{backdrop-filter:blur(16px);background:rgba(253,246,236,.92);border-bottom:1px solid rgba(196,168,130,.3)}
    .fmt-bar{backdrop-filter:blur(12px);background:rgba(253,246,236,.95);border-bottom:1px solid rgba(196,168,130,.2);position:relative;z-index:60}
    .fmt-btn{width:32px;height:32px;display:inline-flex;align-items:center;justify-content:center;border-radius:6px;cursor:pointer;border:none;background:transparent;color:rgba(44,24,16,.55);font-size:13px;transition:all .15s;position:relative}
    .fmt-btn:hover{background:rgba(196,168,130,.25);color:#2c1810}
    .fmt-btn.active{background:rgba(196,168,130,.35);color:#2c1810;font-weight:700}
    .fmt-sep{width:1px;height:20px;background:rgba(196,168,130,.25);margin:0 2px;display:inline-block;vertical-align:middle}

    /* Text element on canvas */
    .txt-el{
      position:absolute;
      min-width:2px;
      padding:4px 6px;
      border:2px solid transparent;
      border-radius:4px;
      cursor:default;
      transition:border-color .15s;
      background:transparent;
      resize:both;
      overflow:hidden;
    }
    .txt-el:hover{border-color:rgba(166,139,107,.3)}
    .txt-el.selected{border-color:#a68b6b;box-shadow:0 0 0 1px rgba(166,139,107,.2);resize:both;overflow:auto}
    .txt-el.editing{border-color:#8b7355;background:rgba(255,255,255,.2);resize:both;overflow:auto}
    .txt-el.dragging{opacity:.8;cursor:grabbing}
    .txt-el .txt-content{
      outline:none;min-height:20px;line-height:1.6;
      font-family:'DM Sans',sans-serif;font-size:16px;color:#2c1810;
      word-break:break-word;white-space:pre-wrap;
    }

    /* Selection handles */
    .sel-handle{
      position:absolute;width:8px;height:8px;background:white;
      border:2px solid #a68b6b;border-radius:2px;display:none;z-index:5;
    }
    .txt-el.selected .sel-handle{display:block}
    .sel-handle.tl{top:-5px;left:-5px;cursor:nwse-resize}
    .sel-handle.tr{top:-5px;right:-5px;cursor:nesw-resize}
    .sel-handle.bl{bottom:-5px;left:-5px;cursor:nesw-resize}
    .sel-handle.br{bottom:-5px;right:-5px;cursor:nwse-resize}

    /* Canvas - WHITE background */
    #canvasWrapper{background:#ffffff !important}
    #noteCanvas{position:relative;width:4000px;height:4000px;cursor:text}

    /* Color pickers */
    .color-picker-dropdown{
      position:absolute;top:calc(100% + 6px);left:50%;transform:translateX(-50%);
      background:white;border-radius:10px;padding:8px;
      box-shadow:0 8px 30px rgba(0,0,0,.2);display:none;z-index:200;
      gap:5px;flex-wrap:wrap;width:148px;
    }
    .color-picker-dropdown.show{display:flex}
    .cp-swatch{width:24px;height:24px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:transform .1s,border-color .15s}
    .cp-swatch:hover{transform:scale(1.2);border-color:#2c1810}

    /* Note color dots */
    .note-color-dot{width:20px;height:20px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:transform .15s,border-color .15s}
    .note-color-dot:hover{transform:scale(1.15)}
    .note-color-dot.active{border-color:#2c1810;transform:scale(1.1)}
    .nc-yellow{background:#fff9c4}.nc-pink{background:#f8bbd0}.nc-blue{background:#b3e5fc}
    .nc-green{background:#c8e6c9}.nc-orange{background:#ffe0b2}.nc-purple{background:#e1bee7}
    .nc-white{background:#ffffff;border:1px solid #ddd}

    /* Canvas color tint overlay */
    .canvas-tint{position:absolute;inset:0;pointer-events:none;z-index:0}

    /* Mode indicator */
    .mode-pill{
      position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
      background:rgba(44,24,16,.8);color:#fdf6ec;font-size:11px;
      padding:6px 16px;border-radius:20px;z-index:100;
      transition:opacity .3s;pointer-events:none;
      font-family:'DM Sans',sans-serif;
    }

    /* Save indicator */
    .save-indicator{
      display:inline-flex;align-items:center;gap:4px;
      font-size:11px;color:rgba(44,24,16,.35);
      transition:all .3s;
    }
    .save-indicator.saving{color:#e67e22}
    .save-indicator.saved{color:#27ae60}
    .save-indicator svg{width:14px;height:14px}

    /* Sidebar save icon */
    .sidebar-save{opacity:0;transition:opacity .3s}
    .sidebar-save.show{opacity:1}

    @keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}.fade-in{animation:fadeIn .5s ease-out}
    @keyframes slideIn{from{opacity:0;transform:translateX(-8px)}to{opacity:1;transform:translateX(0)}}.slide-in{animation:slideIn .2s ease-out}
    @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
    @keyframes checkPop{0%{transform:scale(0)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
    .check-pop{animation:checkPop .3s ease-out}

    .sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:35}
    .sidebar-overlay.show{display:block}
    @media(max-width:640px){
      .sidebar{position:fixed;left:0;top:0;bottom:0;z-index:45;width:270px;box-shadow:4px 0 24px rgba(0,0,0,.15)}
      .sidebar.collapsed{width:0}
    }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="loginPage" class="hidden login-bg flex items-center justify-center min-h-screen p-4">
    <div class="text-center fade-in max-w-md w-full">
      <div class="mb-8">
        <span class="font-hand text-7xl text-ink block mb-2">üìå Catatan Crysna</span>
        <p class="text-ink/60 font-body text-lg leading-relaxed">Simpan catatan di awan. Tulis, seret, atur sesuka hati.<br>Catatanmu aman &mdash; bisa diakses dari mana saja.</p>
      </div>
      <button onclick="loginWithGoogle()" class="inline-flex items-center gap-3 px-8 py-4 bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all hover:-translate-y-0.5 border border-cork/20 group">
        <svg class="w-6 h-6" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        <span class="font-body font-medium text-ink">Masuk dengan Google</span>
      </button>
      <div class="mt-6 flex items-center gap-4 max-w-xs mx-auto"><div class="h-px bg-ink/10 flex-1"></div><span class="text-ink/30 text-xs">atau</span><div class="h-px bg-ink/10 flex-1"></div></div>
      <button onclick="toggleEmailForm()" class="mt-4 inline-flex items-center gap-2 px-6 py-3 bg-ink/5 rounded-xl hover:bg-ink/10 transition-colors border border-ink/10"><span>‚úâÔ∏è</span><span class="font-body text-sm text-ink/70">Masuk dengan Email</span></button>
      <div id="emailForm" class="hidden mt-6 max-w-sm mx-auto text-left fade-in">
        <input id="emailInput" type="email" placeholder="email@contoh.com" class="w-full px-4 py-3 rounded-xl border border-cork/30 bg-white text-ink font-body text-sm focus:outline-none focus:ring-2 focus:ring-cork mb-3"/>
        <input id="passwordInput" type="password" placeholder="Password (min 6 karakter)" class="w-full px-4 py-3 rounded-xl border border-cork/30 bg-white text-ink font-body text-sm focus:outline-none focus:ring-2 focus:ring-cork mb-3"/>
        <div class="flex gap-2">
          <button onclick="signUpEmail()" class="flex-1 py-3 rounded-xl bg-cork text-white font-medium text-sm hover:bg-cork-dark transition-colors">Daftar Baru</button>
          <button onclick="signInEmail()" class="flex-1 py-3 rounded-xl bg-ink text-cream font-medium text-sm hover:bg-ink/90 transition-colors">Masuk</button>
        </div>
      </div>
      <p id="authError" class="mt-4 text-red-500 text-sm font-body hidden"></p>
    </div>
  </div>

  <!-- APP -->
  <div id="appPage" class="hidden h-screen flex flex-col">
    <!-- Top bar -->
    <header class="top-bar px-4 py-2.5 flex items-center justify-between z-50 shrink-0">
      <div class="flex items-center gap-3">
        <button onclick="toggleSidebar()" class="text-ink/50 hover:text-ink/80 transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h10"/></svg></button>
        <span class="font-hand text-2xl text-ink">üìå Catatan Crysna</span>
      </div>
      <div class="flex items-center gap-2">
        <img id="userAvatar" src="" alt="" class="w-7 h-7 rounded-full object-cover border-2 border-cork/30 hidden"/>
        <span id="userName" class="text-sm text-ink/60 font-body hidden sm:block max-w-[120px] truncate"></span>
        <button onclick="logout()" class="text-ink/40 hover:text-ink/70 transition-colors ml-1" title="Keluar"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg></button>
      </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
      <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

      <!-- Sidebar -->
      <aside id="sidebar" class="sidebar flex flex-col shrink-0 h-full">
        <div class="px-4 py-3 border-b border-cork/15 flex items-center justify-between shrink-0">
          <span class="font-body text-xs font-medium text-ink/50 uppercase tracking-wider">Catatan</span>
          <span id="sidebarCount" class="text-[10px] text-ink/30 font-body bg-ink/5 px-2 py-0.5 rounded-full"></span>
        </div>
        <div class="px-3 py-2 shrink-0">
          <input id="searchInput" type="text" placeholder="Cari catatan..." class="w-full px-3 py-2 rounded-lg bg-ink/5 border-0 text-xs font-body text-ink placeholder-ink/30 focus:outline-none focus:ring-1 focus:ring-cork/40" oninput="renderSidebar()"/>
        </div>
        <div id="sidebarList" class="flex-1 overflow-y-auto px-1 pb-2"></div>
        <div class="px-3 py-3 border-t border-cork/15 shrink-0">
          <button onclick="addNote()" class="w-full flex items-center justify-center gap-2 py-2.5 bg-ink text-cream rounded-xl text-sm font-medium hover:bg-ink/90 transition-colors"><span class="text-base leading-none">+</span> Catatan Baru</button>
        </div>
      </aside>

      <!-- Main -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Note header + format bar -->
        <div id="noteToolbar" class="hidden shrink-0" style="z-index:60">
          <div class="fmt-bar px-4 py-2 flex items-center gap-3 flex-wrap">
            <input id="noteTitleInput" type="text" placeholder="Judul catatan..." class="font-hand text-xl font-bold bg-transparent border-none outline-none text-ink flex-1 min-w-[120px]"/>
            <!-- Save indicator -->
            <div id="saveIndicator" class="save-indicator">
              <svg id="saveIconIdle" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
              <span id="saveText">Tersimpan</span>
            </div>
            <span id="noteDate" class="text-[11px] text-ink/30 font-body shrink-0"></span>
            <div class="flex items-center gap-1 shrink-0">
              <div class="note-color-dot nc-white" data-color="note-white" onclick="changeNoteColor(this)" title="Putih"></div>
              <div class="note-color-dot nc-yellow active" data-color="note-yellow" onclick="changeNoteColor(this)" title="Kuning"></div>
              <div class="note-color-dot nc-pink" data-color="note-pink" onclick="changeNoteColor(this)" title="Pink"></div>
              <div class="note-color-dot nc-blue" data-color="note-blue" onclick="changeNoteColor(this)" title="Biru"></div>
              <div class="note-color-dot nc-green" data-color="note-green" onclick="changeNoteColor(this)" title="Hijau"></div>
              <div class="note-color-dot nc-orange" data-color="note-orange" onclick="changeNoteColor(this)" title="Oranye"></div>
              <div class="note-color-dot nc-purple" data-color="note-purple" onclick="changeNoteColor(this)" title="Ungu"></div>
            </div>
            <button onclick="deleteCurrentNote()" class="text-ink/30 hover:text-red-500 transition-colors shrink-0" title="Hapus"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
          </div>
          <!-- Format toolbar -->
          <div class="fmt-bar px-4 py-1.5 flex items-center gap-1 flex-wrap" style="z-index:70">
            <button class="fmt-btn" onmousedown="execFmtBtn(event,'bold')" title="Bold" id="btnBold"><b>B</b></button>
            <button class="fmt-btn" onmousedown="execFmtBtn(event,'italic')" title="Italic" id="btnItalic"><i>I</i></button>
            <button class="fmt-btn" onmousedown="execFmtBtn(event,'underline')" title="Underline" id="btnUnderline"><u>U</u></button>
            <button class="fmt-btn" onmousedown="execFmtBtn(event,'strikeThrough')" title="Coret" id="btnStrike"><s>S</s></button>
            <div class="fmt-sep"></div>
            <select id="fontSizeSelect" onchange="changeFontSize(this.value)" class="fmt-btn text-xs bg-transparent border border-cork/20 rounded-md px-1 cursor-pointer" style="width:58px" title="Ukuran">
              <option value="1">10</option><option value="2">13</option><option value="3" selected>16</option>
              <option value="4">18</option><option value="5">24</option><option value="6">32</option><option value="7">48</option>
            </select>
            <div class="fmt-sep"></div>
            <!-- Text color -->
            <div style="position:relative;display:inline-block">
              <button class="fmt-btn" onmousedown="togglePickerBtn(event,'textCP')" title="Warna Teks" id="btnTC">
                <span style="font-weight:700">A</span>
                <span id="tcBar" style="position:absolute;bottom:3px;left:8px;right:8px;height:3px;background:#2c1810;border-radius:2px"></span>
              </button>
              <div id="textCP" class="color-picker-dropdown">
                <div class="cp-swatch" style="background:#2c1810" onmousedown="setTCBtn(event,'#2c1810')"></div>
                <div class="cp-swatch" style="background:#e74c3c" onmousedown="setTCBtn(event,'#e74c3c')"></div>
                <div class="cp-swatch" style="background:#e67e22" onmousedown="setTCBtn(event,'#e67e22')"></div>
                <div class="cp-swatch" style="background:#f1c40f" onmousedown="setTCBtn(event,'#f1c40f')"></div>
                <div class="cp-swatch" style="background:#27ae60" onmousedown="setTCBtn(event,'#27ae60')"></div>
                <div class="cp-swatch" style="background:#3498db" onmousedown="setTCBtn(event,'#3498db')"></div>
                <div class="cp-swatch" style="background:#8e44ad" onmousedown="setTCBtn(event,'#8e44ad')"></div>
                <div class="cp-swatch" style="background:#e91e8f" onmousedown="setTCBtn(event,'#e91e8f')"></div>
                <div class="cp-swatch" style="background:#ffffff;border:1px solid #ccc" onmousedown="setTCBtn(event,'#ffffff')"></div>
                <div class="cp-swatch" style="background:#95a5a6" onmousedown="setTCBtn(event,'#95a5a6')"></div>
              </div>
            </div>
            <!-- Highlight -->
            <div style="position:relative;display:inline-block">
              <button class="fmt-btn" onmousedown="togglePickerBtn(event,'hlCP')" title="Highlight">
                <span style="background:#fff176;padding:0 3px;border-radius:2px;font-weight:700;font-size:12px">H</span>
              </button>
              <div id="hlCP" class="color-picker-dropdown">
                <div class="cp-swatch" style="background:transparent;border:1px dashed #ccc" onmousedown="setHLBtn(event,false)"></div>
                <div class="cp-swatch" style="background:#fff176" onmousedown="setHLBtn(event,'#fff176')"></div>
                <div class="cp-swatch" style="background:#aed581" onmousedown="setHLBtn(event,'#aed581')"></div>
                <div class="cp-swatch" style="background:#4fc3f7" onmousedown="setHLBtn(event,'#4fc3f7')"></div>
                <div class="cp-swatch" style="background:#f48fb1" onmousedown="setHLBtn(event,'#f48fb1')"></div>
                <div class="cp-swatch" style="background:#ffab91" onmousedown="setHLBtn(event,'#ffab91')"></div>
                <div class="cp-swatch" style="background:#ce93d8" onmousedown="setHLBtn(event,'#ce93d8')"></div>
              </div>
            </div>
            <div class="fmt-sep"></div>
            <button class="fmt-btn" onmousedown="execFmtBtn(event,'justifyLeft')" title="Rata Kiri"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-width="2" d="M3 6h18M3 12h12M3 18h16"/></svg></button>
            <button class="fmt-btn" onmousedown="execFmtBtn(event,'justifyCenter')" title="Rata Tengah"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-width="2" d="M3 6h18M6 12h12M4 18h16"/></svg></button>
            <button class="fmt-btn" onmousedown="execFmtBtn(event,'justifyRight')" title="Rata Kanan"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-width="2" d="M3 6h18M9 12h12M5 18h16"/></svg></button>
            <div class="fmt-sep"></div>
            <span class="text-[10px] text-ink/30 font-body ml-1" id="modeTip">Klik di canvas untuk menulis</span>
          </div>
        </div>

        <!-- Canvas - WHITE background -->
        <div id="canvasWrapper" class="flex-1 overflow-auto relative" style="z-index:1;background:#ffffff">
          <div id="noteCanvas" onmousedown="onCanvasClick(event)"></div>
          <div id="welcomeState" class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div class="text-center"><span class="text-6xl block mb-4">üìù</span><p class="font-hand text-3xl text-ink/30">Pilih atau buat catatan</p><p class="font-body text-sm text-ink/20 mt-2">Pilih catatan dari sidebar atau klik "Catatan Baru"</p></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- LOADING -->
  <div id="loadingPage" class="fixed inset-0 bg-cream flex items-center justify-center z-[9998]">
    <div class="text-center fade-in"><span class="font-hand text-5xl text-ink block mb-4">üìå</span><p class="font-body text-ink/40 text-sm">Memuat...</p></div>
  </div>

  <!-- Mode pill -->
  <div id="modePill" class="mode-pill" style="opacity:0"></div>

  <script>
    // ===== CONFIG =====
    const SUPABASE_URL='https://ejkjiwkzvmsqbkeuzold.supabase.co';
    const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqa2ppd2t6dm1zcWJrZXV6b2xkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MTUxMjAsImV4cCI6MjA4NjM5MTEyMH0.6hxr8lqW5idrWfwfPhMWI2M9oUrr2NlZgJE9xOlM6Fc';
    const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

    // ===== STATE =====
    let currentUser=null, notes=[], activeNoteId=null, selectedElId=null, editingElId=null;
    let dragState=null, sidebarOpen=innerWidth>640;
    let savedSelection=null; // Store selection for format buttons

    const tintMap={
      'note-white':'transparent',
      'note-yellow':'rgba(255,249,196,.15)',
      'note-pink':'rgba(248,187,208,.15)',
      'note-blue':'rgba(179,229,252,.15)',
      'note-green':'rgba(200,230,201,.15)',
      'note-orange':'rgba(255,224,178,.15)',
      'note-purple':'rgba(225,190,231,.15)'
    };
    const colorMap={
      'note-white':'#ffffff',
      'note-yellow':'#fff9c4',
      'note-pink':'#f8bbd0',
      'note-blue':'#b3e5fc',
      'note-green':'#c8e6c9',
      'note-orange':'#ffe0b2',
      'note-purple':'#e1bee7'
    };

    function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
    function uid(){return'b'+Date.now().toString(36)+Math.random().toString(36).substr(2,5)}
    function formatDate(d){if(!d)return'';const o=new Date(d),M=['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'];return`${o.getDate()} ${M[o.getMonth()]} ${o.getFullYear()}, ${String(o.getHours()).padStart(2,'0')}:${String(o.getMinutes()).padStart(2,'0')}`}
    function relDate(d){if(!d)return'';const diff=Date.now()-new Date(d),m=Math.floor(diff/6e4),h=Math.floor(diff/36e5),dy=Math.floor(diff/864e5);if(m<1)return'Baru saja';if(m<60)return m+' mnt lalu';if(h<24)return h+' jam lalu';if(dy<7)return dy+' hari lalu';return formatDate(d)}
    function showPill(t){const p=document.getElementById('modePill');p.textContent=t;p.style.opacity='1';clearTimeout(p._t);p._t=setTimeout(()=>p.style.opacity='0',1500)}

    // ===== SELECTION SAVE/RESTORE =====
    function saveSelection(){
      const sel=window.getSelection();
      if(sel.rangeCount>0){
        savedSelection=sel.getRangeAt(0).cloneRange();
      }
    }
    function restoreSelection(){
      if(savedSelection){
        const sel=window.getSelection();
        sel.removeAllRanges();
        sel.addRange(savedSelection);
      }
    }

    // ===== PAGES =====
    function showPage(p){['loginPage','appPage','loadingPage'].forEach(id=>document.getElementById(id).classList.add('hidden'));document.getElementById(p+'Page')?.classList.remove('hidden');if(p==='app'){const s=document.getElementById('sidebar');sidebarOpen?s.classList.remove('collapsed'):s.classList.add('collapsed')}}

    // ===== AUTH =====
    async function loginWithGoogle(){const{error}=await sb.auth.signInWithOAuth({provider:'google',options:{redirectTo:location.origin+location.pathname}});if(error)showAuthError(error.message)}
    function toggleEmailForm(){document.getElementById('emailForm').classList.toggle('hidden')}
    async function signUpEmail(){const e=document.getElementById('emailInput').value.trim(),p=document.getElementById('passwordInput').value;if(!e||!p)return showAuthError('Isi email dan password!');if(p.length<6)return showAuthError('Password minimal 6 karakter!');const{error}=await sb.auth.signUp({email:e,password:p});if(error)return showAuthError(error.message);showAuthError('Cek email untuk konfirmasi! üì¨',false)}
    async function signInEmail(){const e=document.getElementById('emailInput').value.trim(),p=document.getElementById('passwordInput').value;if(!e||!p)return showAuthError('Isi email dan password!');const{data,error}=await sb.auth.signInWithPassword({email:e,password:p});if(error)return showAuthError(error.message);onAuth(data.session)}
    async function logout(){await sb.auth.signOut();currentUser=null;notes=[];activeNoteId=null;showPage('login')}
    function showAuthError(msg,isErr=true){const el=document.getElementById('authError');el.textContent=msg;el.className=`mt-4 text-sm font-body ${isErr?'text-red-500':'text-green-600'}`;el.classList.remove('hidden');setTimeout(()=>el.classList.add('hidden'),5000)}
    async function onAuth(session){if(!session)return showPage('login');currentUser=session.user;const m=currentUser.user_metadata||{};document.getElementById('userName').textContent=m.full_name||m.name||currentUser.email?.split('@')[0]||'User';document.getElementById('userName').classList.remove('hidden');if(m.avatar_url||m.picture){document.getElementById('userAvatar').src=m.avatar_url||m.picture;document.getElementById('userAvatar').classList.remove('hidden')}showPage('app');await loadNotes()}

    // ===== SIDEBAR =====
    function toggleSidebar(){sidebarOpen=!sidebarOpen;document.getElementById('sidebar').classList.toggle('collapsed',!sidebarOpen);const ov=document.getElementById('sidebarOverlay');(sidebarOpen&&innerWidth<=640)?ov.classList.add('show'):ov.classList.remove('show')}

    // Track saving states per note
    let savingNotes = new Set();

    function renderSidebar(){
      const q=(document.getElementById('searchInput')?.value||'').toLowerCase().trim();
      const filtered=notes.filter(n=>{if(!q)return true;const blocks=parseBlocks(n.content);const txt=blocks.map(b=>(b.html||'').replace(/<[^>]*>/g,'')).join(' ').toLowerCase();return(n.title||'').toLowerCase().includes(q)||txt.includes(q)}).sort((a,b)=>new Date(b.updated_at||b.created_at)-new Date(a.updated_at||a.created_at));
      document.getElementById('sidebarCount').textContent=notes.length;
      const list=document.getElementById('sidebarList');
      if(!filtered.length){list.innerHTML=`<div class="text-center py-8"><p class="text-ink/25 text-xs font-body">${q?'Tidak ditemukan':'Belum ada catatan'}</p></div>`;return}
      list.innerHTML=filtered.map(n=>{
        const blocks=parseBlocks(n.content);const preview=blocks.map(b=>(b.html||'').replace(/<[^>]*>/g,'')).join(' ').substring(0,50);
        const isSaving = savingNotes.has(n.id);
        const dotColor = colorMap[n.color]||'#fff9c4';
        const dotBorder = n.color === 'note-white' ? 'box-shadow:0 0 0 1px rgba(0,0,0,.15)' : 'box-shadow:0 0 0 1px rgba(0,0,0,.08)';
        return`<div class="sidebar-item ${activeNoteId===n.id?'active':''} px-3 py-2.5 mx-1 rounded-lg my-0.5 flex gap-2.5 items-start slide-in" onclick="openNote('${n.id}')">
          <div class="sidebar-color-dot mt-1.5" style="background:${dotColor};${dotBorder}"></div>
          <div class="flex-1 min-w-0"><div class="flex items-center gap-1.5"><div class="font-body text-sm font-medium text-ink/80 truncate flex-1">${esc(n.title||'Tanpa Judul')}</div>
          <div class="sidebar-save ${isSaving?'show':''}" id="sidebar-save-${n.id}" title="${isSaving?'Menyimpan...':'Tersimpan'}">
            ${isSaving ?
              '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#e67e22" stroke-width="2.5"><circle cx="12" cy="12" r="10" stroke-dasharray="31.4" stroke-dashoffset="10" style="animation:spin 1s linear infinite;transform-origin:center"/></svg>' :
              '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#27ae60" stroke-width="2.5"><path d="M5 13l4 4L19 7"/></svg>'
            }
          </div></div>
          <div class="font-body text-[11px] text-ink/35 truncate mt-0.5">${esc(preview)||'Catatan kosong...'}</div>
          <div class="font-body text-[10px] text-ink/25 mt-1">${relDate(n.updated_at||n.created_at)}</div></div></div>`;
      }).join('');
    }

    // ===== NOTES CRUD =====
    function parseBlocks(c){if(!c)return[];try{const p=JSON.parse(c);return Array.isArray(p)?p:[]}catch{return[]}}

    async function loadNotes(){
      const{data,error}=await sb.from('notes').select('*').eq('user_id',currentUser.id).order('updated_at',{ascending:false});
      if(error){console.error(error);return}notes=data||[];renderSidebar();
      if(activeNoteId&&notes.find(n=>n.id===activeNoteId))openNote(activeNoteId);else{activeNoteId=null;showWelcome()}
    }

    async function addNote(){
      const now=new Date().toISOString();
      const n={user_id:currentUser.id,title:'Catatan Baru',content:'[]',color:'note-yellow',pos_x:0,pos_y:0,width:240,height:180,z_index:1,created_at:now,updated_at:now};
      const{data,error}=await sb.from('notes').insert(n).select().single();
      if(error){console.error(error);return}notes.unshift(data);renderSidebar();openNote(data.id);
      if(innerWidth<=640&&sidebarOpen)toggleSidebar();
    }

    async function deleteCurrentNote(){
      if(!activeNoteId||!confirm('Hapus catatan ini?'))return;
      await sb.from('notes').delete().eq('id',activeNoteId);
      notes=notes.filter(n=>n.id!==activeNoteId);activeNoteId=null;showWelcome();renderSidebar();
    }

    function showSaveStatus(status){
      const ind = document.getElementById('saveIndicator');
      const txt = document.getElementById('saveText');
      if(!ind) return;
      ind.className = 'save-indicator ' + status;
      if(status==='saving'){
        txt.textContent = 'Menyimpan...';
      } else {
        txt.textContent = 'Tersimpan ‚úì';
        setTimeout(()=>{
          ind.className = 'save-indicator';
          txt.textContent = 'Tersimpan';
        }, 2000);
      }
    }

    function scheduleNoteSave(){
      const note=notes.find(n=>n.id===activeNoteId);if(!note)return;
      // Show saving state
      showSaveStatus('saving');
      savingNotes.add(note.id);
      renderSidebar();

      clearTimeout(note._t);note._t=setTimeout(async()=>{
        note.updated_at=new Date().toISOString();
        await sb.from('notes').update({title:note.title,content:note.content,color:note.color,updated_at:note.updated_at}).eq('id',note.id);
        document.getElementById('noteDate').textContent=formatDate(note.updated_at);
        // Show saved state
        savingNotes.delete(note.id);
        showSaveStatus('saved');
        renderSidebar();
      },700);
    }

    // ===== OPEN / CLOSE NOTE =====
    function openNote(id){
      const note=notes.find(n=>n.id===id);if(!note)return;
      activeNoteId=id;selectedElId=null;editingElId=null;
      document.getElementById('welcomeState').classList.add('hidden');
      document.getElementById('noteToolbar').classList.remove('hidden');
      document.getElementById('noteTitleInput').value=note.title||'';
      document.getElementById('noteTitleInput').oninput=function(){note.title=this.value;scheduleNoteSave()};
      document.getElementById('noteDate').textContent=formatDate(note.updated_at||note.created_at);
      document.querySelectorAll('.note-color-dot').forEach(d=>d.classList.toggle('active',d.dataset.color===note.color));
      applyCanvasTint(note.color);
      renderBlocks();renderSidebar();
      if(innerWidth<=640&&sidebarOpen)toggleSidebar();
    }

    function showWelcome(){
      document.getElementById('welcomeState').classList.remove('hidden');
      document.getElementById('noteToolbar').classList.add('hidden');
      document.getElementById('noteCanvas').innerHTML='';
      applyCanvasTint(null);
    }

    function applyCanvasTint(color){
      const w=document.getElementById('canvasWrapper');
      w.querySelectorAll('.canvas-tint').forEach(e=>e.remove());
      if(color&&tintMap[color]&&tintMap[color]!=='transparent'){
        const t=document.createElement('div');t.className='canvas-tint';
        t.style.background=tintMap[color];
        w.prepend(t);
      }
    }

    // ===== BLOCKS (TEXT ELEMENTS) =====
    function getBlocks(){const note=notes.find(n=>n.id===activeNoteId);return note?parseBlocks(note.content):[]}
    function saveBlocks(blocks){const note=notes.find(n=>n.id===activeNoteId);if(!note)return;note.content=JSON.stringify(blocks);scheduleNoteSave()}

    function renderBlocks(){
      const canvas=document.getElementById('noteCanvas');
      canvas.innerHTML='';canvas.style.width='4000px';canvas.style.height='4000px';
      getBlocks().forEach(b=>createBlockEl(b));
    }

    function createBlockEl(b){
      const div=document.createElement('div');
      div.id='el-'+b.id;div.dataset.bid=b.id;
      div.className='txt-el';
      div.style.left=b.x+'px';div.style.top=b.y+'px';
      if(b.w)div.style.width=b.w+'px';
      if(b.h)div.style.height=b.h+'px';

      div.innerHTML=`
        <div class="sel-handle tl"></div><div class="sel-handle tr"></div>
        <div class="sel-handle bl"></div><div class="sel-handle br"></div>
        <div class="txt-content" contenteditable="false">${b.html||''}</div>`;

      const content=div.querySelector('.txt-content');

      // Handle resize via ResizeObserver
      const resizeObs = new ResizeObserver(entries => {
        for(const entry of entries){
          const w = Math.round(entry.contentRect.width + 12); // padding
          const h = Math.round(entry.contentRect.height + 12);
          if(w > 10 && h > 10){
            const blocks=getBlocks().map(bl=>bl.id===b.id?{...bl,w,h}:bl);
            // Debounce resize save
            clearTimeout(div._resizeT);
            div._resizeT = setTimeout(()=>saveBlocks(blocks), 500);
          }
        }
      });
      resizeObs.observe(div);

      // Handle resize via corner handles
      div.querySelectorAll('.sel-handle').forEach(handle => {
        handle.addEventListener('mousedown', e => {
          e.stopPropagation();
          e.preventDefault();
          startResize(e, b, div, handle);
        });
        handle.addEventListener('touchstart', e => {
          e.stopPropagation();
          e.preventDefault();
          startResize(e, b, div, handle);
        }, {passive:false});
      });

      // Single click = select
      div.addEventListener('mousedown',e=>{
        if(e.target.closest('.sel-handle'))return;
        e.stopPropagation();
        if(editingElId===b.id)return;
        selectEl(b.id);
        if(editingElId!==b.id)startDrag(e,b,div);
      });

      // Double click = edit
      div.addEventListener('dblclick',e=>{
        e.stopPropagation();
        startEditing(b.id);
      });

      // Touch
      let lastTap=0;
      div.addEventListener('touchstart',e=>{
        if(e.target.closest('.sel-handle'))return;
        e.stopPropagation();
        const now=Date.now();
        if(now-lastTap<350){startEditing(b.id);lastTap=0;return}
        lastTap=now;
        if(editingElId===b.id)return;
        selectEl(b.id);
        startDrag(e,b,div);
      },{passive:false});

      // Content input ‚Üí save
      content.addEventListener('input',()=>{
        const blocks=getBlocks().map(bl=>bl.id===b.id?{...bl,html:content.innerHTML}:bl);
        saveBlocks(blocks);
      });

      // Prevent contenteditable from stealing mousedown for drag
      content.addEventListener('mousedown',e=>{
        if(editingElId!==b.id){e.preventDefault()}
      });

      document.getElementById('noteCanvas').appendChild(div);
    }

    // ===== RESIZE via handles =====
    let resizeState = null;

    function startResize(e, block, el, handle){
      e.preventDefault();
      const p = gp(e);
      const rect = el.getBoundingClientRect();
      const isLeft = handle.classList.contains('tl') || handle.classList.contains('bl');
      const isTop = handle.classList.contains('tl') || handle.classList.contains('tr');

      resizeState = {
        block, el,
        sx: p.x, sy: p.y,
        origW: rect.width, origH: rect.height,
        origX: block.x, origY: block.y,
        isLeft, isTop
      };

      document.addEventListener('mousemove', onResize);
      document.addEventListener('mouseup', endResize);
      document.addEventListener('touchmove', onResize, {passive:false});
      document.addEventListener('touchend', endResize);
    }

    function onResize(e){
      if(!resizeState) return;
      e.preventDefault();
      const p = gp(e);
      const dx = p.x - resizeState.sx;
      const dy = p.y - resizeState.sy;

      let newW = resizeState.origW;
      let newH = resizeState.origH;
      let newX = resizeState.origX;
      let newY = resizeState.origY;

      if(resizeState.isLeft){
        newW = Math.max(60, resizeState.origW - dx);
        newX = resizeState.origX + (resizeState.origW - newW);
      } else {
        newW = Math.max(60, resizeState.origW + dx);
      }

      if(resizeState.isTop){
        newH = Math.max(30, resizeState.origH - dy);
        newY = resizeState.origY + (resizeState.origH - newH);
      } else {
        newH = Math.max(30, resizeState.origH + dy);
      }

      resizeState.el.style.width = newW + 'px';
      resizeState.el.style.height = newH + 'px';
      resizeState.el.style.left = newX + 'px';
      resizeState.el.style.top = newY + 'px';

      resizeState._newW = newW;
      resizeState._newH = newH;
      resizeState._newX = newX;
      resizeState._newY = newY;
    }

    function endResize(){
      if(!resizeState) return;
      if(resizeState._newW){
        const blocks = getBlocks().map(bl => bl.id === resizeState.block.id ? {
          ...bl,
          w: Math.round(resizeState._newW),
          h: Math.round(resizeState._newH),
          x: Math.round(resizeState._newX),
          y: Math.round(resizeState._newY)
        } : bl);
        saveBlocks(blocks);
      }
      resizeState = null;
      document.removeEventListener('mousemove', onResize);
      document.removeEventListener('mouseup', endResize);
      document.removeEventListener('touchmove', onResize);
      document.removeEventListener('touchend', endResize);
    }

    function selectEl(id){
      if(editingElId&&editingElId!==id)stopEditing();
      selectedElId=id;
      document.querySelectorAll('.txt-el').forEach(el=>{
        el.classList.toggle('selected',el.dataset.bid===id);
      });
    }

    function deselectAll(){
      if(editingElId)stopEditing();
      selectedElId=null;
      document.querySelectorAll('.txt-el.selected').forEach(el=>el.classList.remove('selected'));
    }

    function startEditing(id){
      selectEl(id);editingElId=id;
      const el=document.getElementById('el-'+id);if(!el)return;
      el.classList.add('editing');
      const content=el.querySelector('.txt-content');
      content.contentEditable='true';
      content.focus();
      const sel=window.getSelection();sel.selectAllChildren(content);sel.collapseToEnd();
    }

    function stopEditing(){
      if(!editingElId)return;
      const el=document.getElementById('el-'+editingElId);
      if(el){
        el.classList.remove('editing');
        el.querySelector('.txt-content').contentEditable='false';
      }
      const blocks=getBlocks();
      const block=blocks.find(b=>b.id===editingElId);
      if(block&&!block.html?.replace(/<[^>]*>/g,'').trim()){
        const filtered=blocks.filter(b=>b.id!==editingElId);
        saveBlocks(filtered);
        el?.remove();
        if(selectedElId===editingElId)selectedElId=null;
      }
      editingElId=null;
    }

    // ===== CLICK ON CANVAS = CREATE TEXT =====
    function onCanvasClick(e){
      if(e.target.closest('.txt-el'))return;
      if(!activeNoteId)return;
      deselectAll();closeAllPickers();
      const canvas=document.getElementById('noteCanvas');
      const rect=canvas.getBoundingClientRect();
      const x=e.clientX-rect.left;
      const y=e.clientY-rect.top;
      const b={id:uid(),html:'',x:Math.max(10,x),y:Math.max(10,y),w:300};
      const blocks=getBlocks();blocks.push(b);saveBlocks(blocks);
      createBlockEl(b);
      setTimeout(()=>startEditing(b.id),30);
    }

    // ===== DRAG =====
    function gp(e){return e.touches?.[0]?{x:e.touches[0].clientX,y:e.touches[0].clientY}:{x:e.clientX,y:e.clientY}}

    function startDrag(e,block,el){
      if(editingElId===block.id)return;
      e.preventDefault();
      const p=gp(e);
      dragState={block,el,sx:p.x,sy:p.y,ox:block.x,oy:block.y,moved:false};
      el.classList.add('dragging');
      document.addEventListener('mousemove',onDrag);document.addEventListener('mouseup',endDrag);
      document.addEventListener('touchmove',onDrag,{passive:false});document.addEventListener('touchend',endDrag);
    }

    function onDrag(e){
      if(!dragState)return;e.preventDefault();
      const p=gp(e);
      const dx=p.x-dragState.sx,dy=p.y-dragState.sy;
      if(Math.abs(dx)>3||Math.abs(dy)>3)dragState.moved=true;
      if(!dragState.moved)return;
      dragState.block.x=Math.max(0,dragState.ox+dx);
      dragState.block.y=Math.max(0,dragState.oy+dy);
      dragState.el.style.left=dragState.block.x+'px';
      dragState.el.style.top=dragState.block.y+'px';
    }

    function endDrag(){
      if(!dragState)return;
      dragState.el.classList.remove('dragging');
      if(dragState.moved){
        const blocks=getBlocks().map(b=>b.id===dragState.block.id?{...b,x:dragState.block.x,y:dragState.block.y}:b);
        saveBlocks(blocks);
      }
      dragState=null;
      document.removeEventListener('mousemove',onDrag);document.removeEventListener('mouseup',endDrag);
      document.removeEventListener('touchmove',onDrag);document.removeEventListener('touchend',endDrag);
    }

    // ===== FORMATTING - FIXED: preserve selection =====
    // Use mousedown + preventDefault to NOT lose focus/selection from contenteditable
    function execFmtBtn(e, cmd, val){
      e.preventDefault(); // Don't steal focus!
      document.execCommand(cmd, false, val || null);
      updateFmtBtns();
      // Save content after format change
      if(editingElId){
        const el = document.getElementById('el-'+editingElId);
        if(el){
          const content = el.querySelector('.txt-content');
          const blocks = getBlocks().map(bl => bl.id === editingElId ? {...bl, html: content.innerHTML} : bl);
          saveBlocks(blocks);
        }
      }
    }

    function changeFontSize(val){
      document.execCommand('fontSize', false, val);
      if(editingElId){
        const el = document.getElementById('el-'+editingElId);
        if(el){
          const content = el.querySelector('.txt-content');
          const blocks = getBlocks().map(bl => bl.id === editingElId ? {...bl, html: content.innerHTML} : bl);
          saveBlocks(blocks);
        }
      }
    }

    function togglePickerBtn(e, id){
      e.preventDefault();
      const el=document.getElementById(id);
      const was=el.classList.contains('show');
      closeAllPickers();
      if(!was)el.classList.add('show');
    }

    function setTCBtn(e, c){
      e.preventDefault();
      document.execCommand('foreColor', false, c);
      document.getElementById('tcBar').style.background=c;
      closeAllPickers();
      // Save
      if(editingElId){
        const el = document.getElementById('el-'+editingElId);
        if(el){
          const content = el.querySelector('.txt-content');
          const blocks = getBlocks().map(bl => bl.id === editingElId ? {...bl, html: content.innerHTML} : bl);
          saveBlocks(blocks);
        }
      }
    }

    function setHLBtn(e, c){
      e.preventDefault();
      if(!c){
        document.execCommand('removeFormat');
      } else {
        document.execCommand('hiliteColor', false, c);
      }
      closeAllPickers();
      // Save
      if(editingElId){
        const el = document.getElementById('el-'+editingElId);
        if(el){
          const content = el.querySelector('.txt-content');
          const blocks = getBlocks().map(bl => bl.id === editingElId ? {...bl, html: content.innerHTML} : bl);
          saveBlocks(blocks);
        }
      }
    }

    function closeAllPickers(){document.querySelectorAll('.color-picker-dropdown').forEach(e=>e.classList.remove('show'))}
    function updateFmtBtns(){
      document.getElementById('btnBold')?.classList.toggle('active',document.queryCommandState('bold'));
      document.getElementById('btnItalic')?.classList.toggle('active',document.queryCommandState('italic'));
      document.getElementById('btnUnderline')?.classList.toggle('active',document.queryCommandState('underline'));
      document.getElementById('btnStrike')?.classList.toggle('active',document.queryCommandState('strikeThrough'));
    }
    document.addEventListener('selectionchange',updateFmtBtns);

    // ===== NOTE COLOR =====
    function changeNoteColor(el){
      const note=notes.find(n=>n.id===activeNoteId);if(!note)return;
      note.color=el.dataset.color;
      document.querySelectorAll('.note-color-dot').forEach(d=>d.classList.toggle('active',d.dataset.color===note.color));
      applyCanvasTint(note.color);scheduleNoteSave();renderSidebar();
    }

    // ===== KEYBOARD =====
    document.addEventListener('keydown',e=>{
      if((e.ctrlKey||e.metaKey)&&e.key==='n'){e.preventDefault();if(currentUser)addNote()}
      if((e.key==='Delete'||e.key==='Backspace')&&selectedElId&&!editingElId){
        e.preventDefault();
        const blocks=getBlocks().filter(b=>b.id!==selectedElId);
        document.getElementById('el-'+selectedElId)?.remove();
        selectedElId=null;saveBlocks(blocks);
      }
      if(e.key==='Escape'){
        if(editingElId)stopEditing();
        else deselectAll();
      }
      if(e.key==='Enter'&&selectedElId&&!editingElId){
        e.preventDefault();startEditing(selectedElId);
      }
    });

    // Click outside blocks = deselect
    document.addEventListener('mousedown',e=>{
      if(!e.target.closest('.txt-el')&&!e.target.closest('.fmt-bar')&&!e.target.closest('.fmt-btn')&&!e.target.closest('.color-picker-dropdown')&&!e.target.closest('.note-color-dot')&&!e.target.closest('#noteTitleInput')){
        closeAllPickers();
      }
    });

    window.addEventListener('resize',()=>{const ov=document.getElementById('sidebarOverlay');innerWidth>640?ov.classList.remove('show'):sidebarOpen&&ov.classList.add('show')});

    // ===== INIT =====
    async function init(){
      showPage('loading');
      const{data:{session}}=await sb.auth.getSession();
      if(session)await onAuth(session);else showPage('login');
      sb.auth.onAuthStateChange(async(ev,s)=>{if(ev==='SIGNED_IN'&&s&&!currentUser)await onAuth(s)});
    }
    init();
  </script>
</body>
</html>
